# 第17章

> Rails と Sinatra では、残念ながら標準ではパラメーターの型変換 に対応していません。
> Rails 向けであれば、そのための外部ライブラリは存在します。

ActiveRecord なら、モデルクラスに値をセットすると自動的に型変換される。
ずるいというか、悪意のある言い方？

### フェイルオープン、フェイルクローズ

```rb
# ファイルオープン
# アクションを追加する時に、ここの only に追加し忘れる。 
before_action :check_access, only: [:create]

# フェイルクローズ
# 追加し忘れることがない。
# チェックしないアクションを追加する際は、テストで見つけられる
before_action :check_access, except: [:index, :bars]
```

フェイルクローズな考え方
- ネットワークアクセス制御の考え方
  - deny-all -> allow-hosts
  - まずは全部接続拒否して、許可するホストを個別に設定していく

```
# フェイルクローズ
before_action :require_login
skip_before_action :require_login, only: [:index, :bars]

# つまり以下と同じ
before_action :require_login, except: [:index, :bars]
```

### インジェクション

Rails批判的な書き方。
> テンプレートで出力されているあらゆる文字列は適切に
> 「HTML セーフである」とマークされているはずだ、と信用するしかありません。

想定している状況がよくわからない。

- リクエスト
  ```
  ?name=<script>Do+bad+things</script>
  ```
- ERB
  ```rb
  <%= params['name'] %>
  ```
- 出力結果
  ちゃんとエスケープされるはず。
  ```
  &gt;script&lt;Do bad things&gt;/script&lt;
  ```

#### SQLインジェクション

いまだに起こりうる。重要。
インジェクションリスクの可能性が一番高いのがこれ。

> 経験を積んだ Rails プ ログラマーならお馴染みの脆弱性です。
> しかし、あまりにも簡単に引き起こせるの で現在でも定期的に問題となっています。

重要なのに、コード例が少なかった。
逆に文献がたくさんあるから、中級向けの本書ではわざわざ説明しなくても良いだろう、ということか。

プレースホルダ使いましょう。

### メモリアドレス空間配置のランダム化

そこ攻撃される時点で、サーバに侵入されている。
> メモリアドレス空間を固有に
 ≠ メモリアドレス空間を固定化

ランダム化と固有化はニュアンスの違う言葉。
固定化に似ている言葉なので、ランダムにすべきと言っているのか、固定にすべきと言っているのか、分かりにくい。

Webアプリのセキュリティでは、ネットワーク侵入のレベルで防衛するので、
あまり気にしなくて良い。


ファイルシステム、システムコールについても同様。
そこ攻撃されている時点で、ネットワークやサーバ内に侵入されている。手遅れ。
Rubyというプログラミング言語の観点では、確かに考慮すべきセキュリティレイヤになってくるが、
Webアプリ開発者は、別の観点でのセキュリティ対策が求められる。


